<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>gcpdiag Architecture | gcpdiag</title>
<meta name=description content="gcpdiag internal code architecture.
">
<meta property="og:title" content="gcpdiag Architecture">
<meta property="og:description" content="gcpdiag internal code architecture.
">
<meta property="og:type" content="article">
<meta property="og:url" content="https://gcpdiag.dev/docs/development/architecture/"><meta property="og:image" content="https://gcpdiag.dev/images/website-preview.jpg"><meta property="article:section" content="docs">
<meta property="article:modified_time" content="2021-10-20T22:14:24+02:00"><meta property="og:site_name" content="gcpdiag">
<meta itemprop=name content="gcpdiag Architecture">
<meta itemprop=description content="gcpdiag internal code architecture.
">
<meta itemprop=dateModified content="2021-10-20T22:14:24+02:00">
<meta itemprop=wordCount content="1715"><meta itemprop=image content="https://gcpdiag.dev/images/website-preview.jpg">
<meta itemprop=keywords content><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://gcpdiag.dev/images/website-preview.jpg">
<meta name=twitter:title content="gcpdiag Architecture">
<meta name=twitter:description content="gcpdiag internal code architecture.
">
<link href=/scss/main.css rel=stylesheet>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-light nav-shadow flex-column flex-md-row td-navbar">
<a id=gcpdiag-top class=navbar-brand href=/>
<img src=/images/stethoscope.png height=30><span class=font-weight-bold>&nbsp;gcpdiag</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/docs/><span class=active>Documentation</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/rules/><span>Rules</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=https://github.com/GoogleCloudPlatform/gcpdiag><span>GitHub</span></a>
</li>
</ul>
</div>
<div class="navbar-nav mx-lg-2 d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<div id=content-mobile>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
</div>
<div id=content-desktop></div>
<nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li>
<a href=/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Documentation</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsrunning-li>
<input type=checkbox id=m-docsrunning-check>
<label for=m-docsrunning-check><a href=/docs/running/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsrunning><span>Running gcpdiag</span></a></label>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsusage-li>
<input type=checkbox id=m-docsusage-check>
<label for=m-docsusage-check><a href=/docs/usage/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsusage><span>Usage information</span></a></label>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsauthentication-li>
<input type=checkbox id=m-docsauthentication-check>
<label for=m-docsauthentication-check><a href=/docs/authentication/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsauthentication><span>Authentication</span></a></label>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsdevelopment-li>
<input type=checkbox id=m-docsdevelopment-check checked>
<label for=m-docsdevelopment-check><a href=/docs/development/ title="Development Guides" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsdevelopment><span>Development</span></a></label>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentenvironment-li>
<input type=checkbox id=m-docsdevelopmentenvironment-check>
<label for=m-docsdevelopmentenvironment-check><a href=/docs/development/environment/ title="Development Environment" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentenvironment><span>Dev Environment</span></a></label>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsdevelopmentarchitecture-li>
<input type=checkbox id=m-docsdevelopmentarchitecture-check checked>
<label for=m-docsdevelopmentarchitecture-check><a href=/docs/development/architecture/ title="gcpdiag Architecture" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentarchitecture><span class=td-sidebar-nav-active-item>Architecture</span></a></label>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
<aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#overview>Overview</a></li>
<li><a href=#queries-modules>Queries Modules</a></li>
<li><a href=#context-objects>Context Objects</a></li>
<li><a href=#resource-objects>Resource Objects</a></li>
<li><a href=#lintreportruleinterface>LintReportRuleInterface</a></li>
<li><a href=#rule-modules>Rule Modules</a></li>
<li><a href=#rule-execution>Rule Execution</a></li>
<li><a href=#caching>Caching</a></li>
<li><a href=#api-libraries-and-authentication>API Libraries and Authentication</a></li>
</ul>
</nav></div>
<div class="td-page-meta ml-0 pb-1 pt-0 mb-0">
<a href=https://github.com/GoogleCloudPlatform/gcpdiag/edit/main/website/content/en/docs/development/architecture.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/GoogleCloudPlatform/gcpdiag/issues/new?title=gcpdiag%20Architecture" target=_blank class=mb-2><i class="fab fa-github fa-fw"></i> Create issue</a>
</div>
</aside>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<h1>gcpdiag Architecture</h1>
<div class=lead>gcpdiag internal code architecture.</div>
<header class=article-meta>
</header>
<h2 id=overview>Overview</h2>
<p>gcpdiag exclusively uses <strong>public APIs</strong> and is designed to be a sort of test
suite or <strong>linter</strong>, where each lint rule verifies a single aspect of a GCP
project that might be problematic. Example: the IAM permissions of a service
account are not set correctly so a GCE instance can&rsquo;t send logs to Cloud
Logging.</p>
<p>The high-level architecture of gcpdiag looks as follows:</p>
<p><img src=/images/gcpdiag-architecture.png alt="gcpdiag architecture diagram"></p>
<p>Every lint rule (e.g. <code>gce/bp_2021_001</code> above) is represented as a Python module
that registers to the main command gcpdiag with some metadata about the lint
rule, and the implementation of a <code>run_rule()</code> method to run the rule checking
code. Writing new rules should be as easy and quick as possible, to foster a
lively and up-to-date set of rules.</p>
<h2 id=queries-modules>Queries Modules</h2>
<p>Any queries that are done to the GCP API are done via so-called &ldquo;queries&rdquo;
modules, which encapsulate all the queries that are required by gcpdiag lint
rules. The queries are separated from the lint rules to <strong>facilitate code
reuse</strong> and also to <strong>improve performance</strong>. Most queries done by the query
modules cache their results, so that subsequent queries are very fast. This is
necessary because if every rule needs to do GCP API calls every time that it
needs to verify something, the lint command would take too long to run.</p>
<p>The queries modules are also used to make the implementation of the <strong>lint rules
as simple as possible</strong>. Also, we strive for very good test coverage only for
the queries modules and not for lint rules.</p>
<h2 id=context-objects>Context Objects</h2>
<p>gcpdiag allows users to select the resources that should be inspected by
specifying the following criteria:</p>
<ul>
<li>Project id (mandatory, e.g.: <code>my-project-id</code>)</li>
<li>Regions list (e.g.: <code>us-central1</code>, <code>europe-west2</code>)</li>
<li>Labels list (e.g.: <code>{'environment': 'prod'}</code>, <code>{'environment': 'pre-prod'}</code></li>
</ul>
<p>When all three are specified, all must match (the values in the lists are ORed).</p>
<p><strong><code>models.Context</code></strong> (see:
<a href=http://github.com/GoogleCloudPlatform/gcpdiag/tree/main/gcpdiag/models.py#L30>models.py</a>) represents the
filter given by the user and is used in queries modules to select resources.</p>
<h2 id=resource-objects>Resource Objects</h2>
<p>Queries modules generally return objects that implement the
<strong><code>models.Resource</code></strong> abstract class. A Resource object represents a single
resource in GCP and must have these three methods:</p>
<ul>
<li><code>project_id</code> (property)</li>
<li><code>full_path</code> (property) - returns the full path of this resource (e.g.:
<code>projects/gcpd-gke-1-9b90/zones/europe-west4-a/clusters/gke1</code>)</li>
<li><code>short_path</code> (property) - returns the short name for this resource (e.g.:
<code>gcpd-gke-1-9b90/europe-west4-a/gke1</code>)</li>
</ul>
<p>Queries modules provide functions that generally require as input a <code>Context</code>
object and return a dictionary or list of <code>Resource</code>. It is the responsibility
of those functions to implement the filtering according to the provided context.
For example,
<a href=http://github.com/GoogleCloudPlatform/gcpdiag/tree/main/gcpdiag/queries/gke.py>gke.py</a>
provides:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>get_clusters</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>models</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>Mapping</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87>str</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gke</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>]</span>
</code></pre></div><p>Resource objects provide abstraction to retrieve attributes of these resources,
so for example for a <code>gke.Cluster</code> object you can for example use the
<code>has_logging_enabled()</code> method to check whether logging is enabled:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>gke</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get_clusters</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>values</span><span style=color:#000;font-weight:700>()</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>has_logging_enabled</span><span style=color:#000;font-weight:700>():</span>
    <span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><p>Note that we don&rsquo;t strive to have a complete model for all resources in GCP,
because that would be way beyond the scope of this project. We are only
implementing the functionality that is needed in linting rules, nothing more.
Lint rules are not allowed to access the APIs directly and are also discouraged
to access internal resource representations.</p>
<h2 id=lintreportruleinterface>LintReportRuleInterface</h2>
<p>Lint rules need to report their findings back to the user and we want a way to
do that that is both very simple from a rule-implementation point of view, but
also allows flexibility in structuring the output in a beautiful way in the
console, or also to provide alternative output formats such as JSON or HTML.</p>
<p>The way we achieve that is by abstracting all the lint rule reporting into an
object, that is passed to the lint rule executor, and that is used to report
back the findings. The interface looks as follows:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LintReportRuleInterface</span><span style=color:#000;font-weight:700>:</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>add_skipped</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span>
                  <span style=color:#000>resource</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>Optional</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>models</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Resource</span><span style=color:#000;font-weight:700>],</span>
                  <span style=color:#000>reason</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>,</span>
                  <span style=color:#000>short_info</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>str</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>None</span><span style=color:#000;font-weight:700>):</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>add_ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>models</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Resource</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>short_info</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>str</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>):</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>add_failed</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span>
                 <span style=color:#000>resource</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>models</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Resource</span><span style=color:#000;font-weight:700>,</span>
                 <span style=color:#000>reason</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>,</span>
                 <span style=color:#000>short_info</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>str</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>None</span><span style=color:#000;font-weight:700>):</span>
</code></pre></div><p>Rule modules are given a Context object to determine what they should analyze,
and a LintReportRuleInterface object to report back their findings. The findings
can be for any resource one of:</p>
<ul>
<li>Skipped (the rule is not relevant / can&rsquo;t be checked)</li>
<li>OK</li>
<li>Failed</li>
</ul>
<p>The following diagram shows the information flow:</p>
<p><img src=/images/lintreport-diagram.png alt="LintReport diagram"></p>
<h2 id=rule-modules>Rule Modules</h2>
<p>Creating a new rule should require not more than a page-length of code, because
all the complex querying logic should be implemented in the reusable queries
modules. Each rule implements the rule checking logic as Python functions:</p>
<ul>
<li>
<p><strong>run_rule</strong>(<em>context</em>: models.Context, <em>report</em>:
lint.LintReportRuleInterface):</p>
<p>This function is the main function used to run the rule logic on a certain
<em>context</em> (list of projects + resource selectors). The function is supposed
to provide results about the rule evaluation using the <em>report</em> interface.</p>
</li>
<li>
<p><strong>prefetch_rule</strong>(<em>context</em>: models.Context):</p>
<p>Each run_rule function is called in order of rule execution, one function at
a time. To minimize the total runtime of gcpdiag, rules can implement the
<code>prefetch_rule</code> function to do data collection before the rule is actually
started. The difference is that no reporting is possible: that will need to
happen in the <code>run_rule</code> function. The <code>prefetch_rule</code> functions are called
in parallel using multiple worker threads.</p>
</li>
<li>
<p><strong>prepare_rule</strong>(<em>context</em>: models.Context):</p>
<p>The <code>prepare\_rule</code> function is similar to <code>prefetch\_rule</code> because it is
also used to pre-load data before the rule is executed. The difference is
that the <code>prepare\_rule</code> for all rules is called first, and not in parallel.
This is useful for tasks that need to run as early as possible, but don&rsquo;t
actually take a long time to complete. Currently the only use-case is for
defining logs queries (see:
<a href=codelab-rule-logs.md>Codelab: Logs-based Rule</a>).</p>
</li>
</ul>
<p>Rule modules should <strong>never access the API directly</strong>, but always use query
modules instead. This ensures proper testing and separation of concerns. Also,
this way we can make sure that the queries modules cover all the required
functionality, and that the API calls are cached.</p>
<p>Example code:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#4e9a06>&#34;&#34;&#34;GKE nodes service account permissions for logging.
</span><span style=color:#4e9a06>
</span><span style=color:#4e9a06>The service account used by GKE nodes should have the logging.logWriter
</span><span style=color:#4e9a06>role, otherwise ingestion of logs won&#39;t work.
</span><span style=color:#4e9a06>&#34;&#34;&#34;</span>

<span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>gcp_doctor</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>lint</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>models</span>
<span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>gcp_doctor.queries</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>gke</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>iam</span>

<span style=color:#000>ROLE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;roles/logging.logWriter&#39;</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>run_rule</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>models</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>report</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>lint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>LintReportRuleInterface</span><span style=color:#000;font-weight:700>):</span>
  <span style=color:#8f5902;font-style:italic># Find all clusters with logging enabled.</span>
  <span style=color:#000>clusters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>gke</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get_clusters</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>clusters</span><span style=color:#000;font-weight:700>:</span>
    <span style=color:#000>report</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_skipped</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>None</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;no clusters found&#39;</span><span style=color:#000;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#204a87>sorted</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>clusters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>items</span><span style=color:#000;font-weight:700>()):</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>has_logging_enabled</span><span style=color:#000;font-weight:700>():</span>
      <span style=color:#000>report</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_skipped</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;logging disabled&#39;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>else</span><span style=color:#000;font-weight:700>:</span>
      <span style=color:#000>iam_policy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>iam</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get_project_policy</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>project_id</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#8f5902;font-style:italic># Verify service-account permissions for every nodepool.</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>np</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nodepools</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#000>sa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>service_account</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>iam_policy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>has_role_permissions</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#39;serviceAccount:</span><span style=color:#4e9a06>{</span><span style=color:#000>sa</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ROLE</span><span style=color:#000;font-weight:700>):</span>
          <span style=color:#000>report</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_failed</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>np</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#39;service account: </span><span style=color:#4e9a06>{</span><span style=color:#000>sa</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>missing role: </span><span style=color:#4e9a06>{</span><span style=color:#000>ROLE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#39;</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>else</span><span style=color:#000;font-weight:700>:</span>
          <span style=color:#000>report</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>np</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><p>Metadata about the rule is determined as follows:</p>
<ul>
<li><strong>Product</strong>: directory where the rule is placed. Example: <code>gke</code>.</li>
<li><strong>Class</strong>: filename, e.g.: <code>gke/bp_2021_001_cloudops_enabled.py</code> -> class BP
(see also:
<a href=usage.md#test-products-classes-and-ids>test product classes and ids</a>).</li>
<li><strong>Id</strong>: product+class+id uniquely identify a rule. Also determined by the
filename, same as class (see above).</li>
<li><strong>Short description</strong>: the first line of the module docstring is the rule
short description, this is what appears in the rule line in the report.</li>
<li><strong>Long description</strong>: docstring after the first line. When a rule fails, the
long description is printed as well.</li>
</ul>
<h2 id=rule-execution>Rule Execution</h2>
<p>gcpdiag lint is a general &ldquo;broad&rdquo; diagnostics tool that runs as many diagnostic
test as possible, so that it can detect issues that you are completely unaware
of. GCP API calls can however take a considerable amount of time to complete, so
in order for the total runtime not to be too long, two techniques are used:
<strong>caching</strong> and <strong>parallel execution</strong>.</p>
<p>Caching takes care of making sure that the same query is never executed twice,
and is explained more in detail in the next section.</p>
<p>Parallel execution is implemented as follows:</p>
<p><img src=/images/rule-execution.png alt="rule execution diagram"></p>
<ol>
<li>First, the <code>prepare_rule</code> function of each rule is called (if the rule
defines one). These are called serially in the main thread, and are supposed
to be quick to execute. The main use case is to prepare some aggregated
querying that will need to happen later (only for logs at the moment).</li>
<li>Worker threads are started (currently 10) and execute first all required
logging API queries, then all <code>prefetch_rule</code> functions that rule can
define.</li>
<li>Immediately after starting the worker threads with logs and prefetch_rules,
the main thread continues and starts executing the <code>run_rules</code> functions in
the right order (alphabetically sorted) and synchronously starting to print
the report.</li>
<li>The rule scheduler makes sure that any dependent logging or prefetch_rule
execution that is required by a rule completes, before starting the rule
(e.g. this is shown in the diagram where the second <code>run_rule</code> is executed
only after a certain logs query has finished).</li>
</ol>
<h2 id=caching>Caching</h2>
<p>Every rule is independent and uses the queries modules to query for example the
list of GKE clusters in a project. This makes the implementation of rules
easier, but since multiple rules require the same data, this would mean fetching
for example the list of GKE clusters multiple times. In order to avoid doing the
same query multiple times, the results of API calls are cached either to memory
or to disk.</p>
<p>Considering that the amount of data can be significant and in order to keep the
memory consumption of gcpdiag at reasonable levels, generally caching will be
done to disk, but then most cached data will be deleted once gcpdiag has
finished executing.</p>
<p>The implementation uses the
<a href=http://www.grantjenks.com/docs/diskcache/>diskcache</a> Python module, which uses
Sqlite under the hood to provide a very quick and featureful caching
implementation.</p>
<p>To make the implementation as streamlined as possible, we have implemented a
function decorator called <code>caching.cached_api_call</code>:</p>
<pre tabindex=0><code>@caching.cached_api_call
def get_clusters(context: models.Context) -&gt; Mapping[str, Cluster]:
</code></pre><p><code>cached_api_call</code> is very similar to functools.lru_cache, with the following
differences:</p>
<ul>
<li>uses diskcache, so that the memory footprint doesn&rsquo;t grow uncontrollably.</li>
<li>uses a lock so that if the function is called from two threads
simultaneously, only one API call will be done and the other will wait until
the result is available in the cache.</li>
</ul>
<p>Parameters:</p>
<ul>
<li><code>expire</code>: number of seconds until the key expires (default: expire when the
process ends)</li>
<li><code>in_memory</code>: if true the result will be kept in memory, similarly to
lru_cache (but with the locking).</li>
</ul>
<h2 id=api-libraries-and-authentication>API Libraries and Authentication</h2>
<p>We use the low-level
<a href=https://github.com/googleapis/google-api-python-client>google-api-python-client</a>
and not the new &ldquo;idiomatic&rdquo; client libraries because only the API library has
full support for all GCP APIs (through discovery).</p>
<p>Authentication is done either with the Application Default Credentials (via
gcloud command-line) or with a key file for a service account.</p>
<p>The
<a href=http://github.com/GoogleCloudPlatform/gcpdiag/tree/main/gcpdiag/queries/apis.py><code>apis.get_api</code></a>
function is used to retrieve the API interface and also takes care of doing any
necessary authentication step.</p>
<div class="text-muted mt-5 pt-3 border-top">
Last modified October 20, 2021: <a href=https://github.com/GoogleCloudPlatform/gcpdiag/commit/79be776a3363fbeecf157a0673311e42eb1669a8>initial site, using docsy template (79be776)</a>
</div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel=noopener href=https://github.com/GoogleCloudPlatform/gcpdiag aria-label=GitHub>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 Google LLC All Rights Reserved</small>
<small class=ml-1><a href=/privacy/ target=_blank rel=noopener>Privacy Policy</a></small>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.js></script>
</body>
</html>